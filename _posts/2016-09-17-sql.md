---
title: SQL 语言入门笔记
author: Li Xiang
layout: post
date: 2016-09-17 09:46:39
tags: [Database,SQL]
categories: [Notes,Database]
---

《数据库系统概论》第三章笔记。

# 基础

## SQL 历史

- 1974 年，Boyce 和 Chamberlin 提出，Sequel
- 1986 年 10 月，美国国家标准局（ANSI）的数据库委员会 X3H2 批准，同年公布 SQL 标准文本
- 1987 年，国际化标准组织（ISO）通过这一标准

没有一个数据库系统能够支持 SQL 标准的所有概念和特性。许多软件厂商对 SQL 的基本命令集进行了不同程度的扩充和修改，又可以支持标准以外的一些功能特性。

## SQL 特点

- 综合统一
  + SQL 集 `数据定义语言`、`数据操纵语言`、`数据控制语言` 的功能于一体，可以独立完成数据库生命周期中的全部活动。
    + 定义和修改、删除关系模式，定义和删除视图，插入数据，建立数据库；
    + 对数据库中的数据进行查询和更新；
    + 数据库重构和维护；
    + 数据库安全性、完整性控制，以及事务控制；
    + 嵌入式 SQL 和动态 SQL 定义。
- 高度非过程化
- 面向集合的操作方式
- 以同一种语法结构提供多种使用方式
  + 既是独立语言，又是嵌入式语言
- 语言简洁，易学易用

## SQL 基本概念

三级模式结构
- 外模式：若干视图、部分基本表
- 模式：若干基本表
- 内模式：若干存储文件

---

# 数据定义

## 模式的定义与删除

### 1. 定义模式

`CREATE SCHEMA <模式名> AUTHORIZATION <用户名>`

进行该操作需具备数据库管理员权限，或者获得了数据库管理员授予的 CREATE SCHEMA 的权限。

定义模式实际上定义了一个命名空间，在此可以进一步定义该模式包含的数据库对象。

`CREATE SCHEMA <模式名> AUTHORIZATION <用户名> [<表定义子句>|<视图定义子句>|<授权定义子句>]`

### 2. 删除模式

`DROP SCHEMA <模式名><CASCADE|RESTRICT>`

- `CASCADE` 级联，表示在删除模式时把该模式中所有的数据库对象全部删除；
- `RESTRICT` 限制，表示如果该模式中定义了下属的数据库对象（如表或视图），则拒绝该删除语句的执行。

## 基本表的定义、删除与修改

### 1. 定义基本表

``` sql
CREATE TABLE <表名>
    (<列名><数据类型> [列级完整性约束条件]
    [,<列名><数据类型> [列级完整性约束条件]]
    ...
    [,<表级完整性约束条件>]);
```

### 2. 数据类型

在 SQL 中域的概念用数据类型来实现。定义表的各个属性时需要指明其数据类型及长度。选择数据类型从两方面考虑，一是取值范围，二是要做哪些运算。

数据类型 | 含义
:-------|:----
`CHAR(n)`,`CHARACTER(n)`| 长度为 n 的定长字符串
`VARCHAR(n)`,`CHARACTERVARYING(n)`| 最大长度为 n 的变长字符串
`CLOB`| 字符串大对象
`BLOB`| 二进制大对象
`INT`,`INTEGER`| 长整数（4字节）
`SMALLINT`| 短整数（2字节）
`BIGINT`| 大整数（8字节）
`NUMERIC(p,d)`| 定点数，由 p 位数字（不包括符号、小数点）组成，小数点后面有 d 位数字
`DECIMAL(p,d)`,`DEC(p,d)`| 同 NUMERIC
`REAL` | 取决于机器精度的单精度浮点数
`DOUBLE PRECISION`| 取决于机器精度的双精度浮点数
`FLOAT(n)`| 可选精度的浮点数，精度至少位 n 位数字
`BOOLEAN`| 逻辑布尔量
`DATE`| 日期，包含年、月、日，格式为 YYYY-MM-DD
`TIME`| 时间，包含一日的时、分、秒，格式为 HH:MM:SS
`TIMESTAMP`| 时间戳类型
`INTERVAL`| 时间间隔类型

### 3. 模式与表

三种方法定义基本表所属的模式：
1. 在表名中明显地给出模式名；
2. 在创建模式语句中同时创建表；
3. 设置所属的模式，这样在创建表时表名中不必给出模式名。

显示当前搜索路径：`SHOW search_path`;
设置搜索路径：`SET search_path <模式名>,PUBLIC`;

### 4. 修改基本表

``` sql
ALTER TABLE <表名>
[ADD [COLUMN] <新列名><数据类型> [完整性约束]]
[ADD <表级完整性约束>]
[DROP [COLUMN] <列名> [CASCADE|RESTRICT]]
[DROP CONSTRAINT <完整性约束> [RESTRICT|CASCADE]]
[ALTER COLUMN <列名><数据类型>];
```
### 5. 删除基本表

`DROP TABLE <表名> [RESTRICT|CASCADE]`

不同的数据库产品在遵循 SQL 标准的基础上具体实现细节和处理策略会与标准有差别。

## 索引的建立与删除

建立索引时加快查询速度的有效手段。索引是关系数据库管理系统的内部实现技术，属于内模式范畴。用户不必也不能显式地选择索引。

常见的数据库索引：
- 顺序文件上的索引；
- B+树索引
- 散列索引
- 位图索引

### 1. 建立索引

``` sql
CREATE [UNIQUE] [CLUSTER] INDEX <索引名>
ON <表名>(<列名> [<次序>][,<列名> [<次序>]] ...);
```

### 2. 修改索引

`ALTER INDEX <旧索引名>RENAME TO<新索引名>`

### 3. 删除索引

`DROP INDEX <索引名>`

## 数据字典

> 数据字典时关系数据库管理系统内部的一组系统表，它记录了数据库中所有的定义信息，包括关系模式定义、视图定义、索引定义、完整性约束定义、各类用户对数据库的操作权限、统计信息等。关系数据库管理系统在执行 SQL 的数据定义语句时，实际上就是在更新数据字典表中的相应信息。在进行查询优化和查询处理时，数据字典中的信息是其重要依据。

---

# 数据查询

``` sql
SELECT [ALL|DISTINCT] <目标列表达式> [,<目标列表达式>]...
FROM <表名或视图名> [,<表名或视图名>]|(<SELECT 语句>)[AS]<别名>
[WHERE <条件表达式>]
[GROUP BY <列名1> [HAVING <条件表达式>]]
[ORDER BY <列名2> [ASC|DESC]];
```

## 单表查询

1. 选择表中若干列
2. 选择表中若干元组

查询条件 | 谓词
:------|:-----
比较 | `=`, `>`, `<`, `>=`, `<=`, `!=`, `<>`, `!>`, `!<`; `NOT+上述比较运算符`
确定范围 | `BETWEEN AND`, `NOT BETWEEN AND`
确定集合 | `IN`, `NOT IN`
字符匹配 | `LIKE`, `NOT LIKE`
空值 | `IS NULL`, `IS NOT NULL`
多重条件（逻辑运算）| `AND`, `OR`, `NOT`

3. `OBDER BY` 子句
4. 聚集函数
5. `GROUP BY` 子句

## 连接查询

连接查询：查询同时涉及两个以上的表。

1. 等值与非等值连接的查询
2. 自身连接
3. 外连接
4. 多表连接

## 嵌套查询

> 在 SQL 语言中，一个 `SELECT-FROM-WHERE` 语句称为一个查询块。将一个查询块嵌套再另一个查询块的 `WHERE` 子句或 `HAVING` 短语的条件中的查询称为嵌套查询。

``` sql
SELECT Sname /*外层查询或父查询*/
FROM Student
WHERE Sno IN
    (SELECT Sno /*内层查询或子查询*/
    FROM SC
    WHERE Cno='2');
```

1. 带有 `IN` 谓词的子查询
2. 带有比较运算符的子查询
3. 带有 `ANY (SOME)` 或 `ALL` 谓词的子查询
4. 带有 `EXISTS` 谓词的子查询

## 集合查询

> 集合操作主要包括并操作 `UNION`、交操作 `INTERSECT` 和差操作 `EXCEPT`。参加集合操作的各查询结果的**列数**必须相同；对应项的**数据类型**也必须相同。

## 基于派生表的查询

> 子查询不仅可以出现在 `WHERE` 子句中，还可以出现再 `FROM` 子句中，这时子查询生成的临时派生表称为主查询的查询对象。

---

# 数据更新

## 插入数据

1. 插入元组

``` sql
INSERT
INTO <表名> [(<属性列 1> [, <属性列 2>] ...)]
VALUES (<常量 1> [,<常量 2>]); -- 字符串常量使用单引号括起来
```

2. 插入子查询结果

``` sql
INSERT
INTO <表名> [(<属性列 1> [, <属性列 2>] ...)]
子查询;
```

## 修改数据

``` sql
UPDATE <TABLE>
SET <column>=<expression> [,<column>=<expression>]
[WHERE <condition>];
```

## 删除数据

``` sql
DELETE
FROM <table>
[WHERE <condition>];
```

---

# 空值的处理

空值：不知道或者不存在或者无意义的值。

以下条件取空值：

- 该属性应该有一个值，但目前不知道；
- 该属性不应该有值；
- 由于某种原因不便于填写。

空值的判断：`IS NULL` `IS NOT NULL`。

---

# 视图

`CREATE VIEW`
`ALTER VIEW`
`DROP VIEW`
`SHOW VIEW`

## 视图的作用

- 简化用户操作
- 使用户以多种角度看待同一数据
- 对重构数据库提供了一定程度的逻辑独立性
- 对机密数据提供安全保护
- 适当利用视图可以更清晰地表达查询
